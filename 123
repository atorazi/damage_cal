import random

def calculate_real_defense(vitality, item_defense, strength, health, speed):
    visible_defense = vitality + item_defense + (strength / 10) + (health / 10) + (speed / 20)
    hidden_defense = (health / 10) + (speed / 5)
    real_defense = (visible_defense * 0.45) + hidden_defense
    return real_defense, visible_defense

def calculate_damage(attack_power, real_defense, visible_defense, attacker_level, defender_level, is_critical):
    if real_defense > attack_power:
        return 1 if random.random() < 0.5 else 0  # 50% 확률로 miss 또는 1 데미지
    
    if real_defense < attack_power < real_defense * (8/7):
        return random.randint(1, int(attack_power / 16))
    
    base_damage = random.uniform(
        (attack_power - real_defense) * 2 * (15/16),
        (attack_power - real_defense) * 2 * (17/16)
    )
    
    if is_critical:
        critical_bonus = visible_defense * (attacker_level / defender_level) * 0.5
        return base_damage + critical_bonus
    
    return base_damage

# 예제 사용
attacker = {
    "attack_power": 300,
    "speed": 100,
    "level": 50,
}

defender = {
    "vitality": 200,
    "item_defense": 50,
    "strength": 150,
    "health": 400,
    "speed": 80,
    "level": 45,
}

real_def, visible_def = calculate_real_defense(
    defender["vitality"], defender["item_defense"], defender["strength"], defender["health"], defender["speed"]
)

damage = calculate_damage(attacker["attack_power"], real_def, visible_def, attacker["level"], defender["level"], is_critical=True)
print(f"Calculated Damage: {damage}")
